import asyncio
import sqlite3
import json
from datetime import datetime
from aiogram import Bot, Dispatcher, F
from aiogram.filters import Command
from aiogram.types import (
    Message, WebAppInfo, ReplyKeyboardMarkup, 
    KeyboardButton, ReplyKeyboardRemove
)

# --- SOZLAMALAR ---
API_TOKEN = '8671171107:AAGtDCyrSXcO726BV0WiaiUCIReN2XQDsYM'
ADMIN_ID = 513150881 

bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# --- MA'LUMOTLAR BAZASI ---
def init_db():
    conn = sqlite3.connect('choyxona.db')
    cursor = conn.cursor()
    cursor.execute('''CREATE TABLE IF NOT EXISTS users 
                      (user_id INTEGER PRIMARY KEY, full_name TEXT, phone TEXT)''')
    cursor.execute('''CREATE TABLE IF NOT EXISTS orders 
                      (id INTEGER PRIMARY KEY AUTOINCREMENT, 
                       user_id INTEGER, items TEXT, total_price INTEGER, date TEXT)''')
    conn.commit()
    conn.close()

def get_user(user_id):
    conn = sqlite3.connect('choyxona.db')
    cursor = conn.cursor()
    cursor.execute('SELECT * FROM users WHERE user_id = ?', (user_id,))
    user = cursor.fetchone()
    conn.close()
    return user

# --- TUGMALAR ---
def get_main_menu():
    web_url = "https://mavlonovdiyorbek57-cmd.github.io/menu/" 
    return ReplyKeyboardMarkup(keyboard=[
        [KeyboardButton(text="ğŸ“‹ Menyu", web_app=WebAppInfo(url=web_url))],
        [KeyboardButton(text="ğŸ“¦ Buyurtmalarim"), KeyboardButton(text="ğŸŒŸ Fikr qoldirish")]
    ], resize_keyboard=True)

def get_register_kb():
    return ReplyKeyboardMarkup(keyboard=[
        [KeyboardButton(text="ğŸ“± Telefon raqamni yuborish", request_contact=True)]
    ], resize_keyboard=True)

# --- HANDLERLAR ---

@dp.message(Command("start"))
async def start_cmd(message: Message):
    init_db()
    user = get_user(message.from_user.id)
    
    if user:
        # Agar foydalanuvchi bazada bo'lsa, menyuni chiqaramiz
        await message.answer(
            f"Xush kelibsiz, {user[1]}! ğŸ‘‹\nBuyurtma berishni boshlashingiz mumkin.",
            reply_markup=get_main_menu()
        )
    else:
        # Agar bazada bo'lmasa, ro'yxatdan o'tishni so'raymiz
        await message.answer(
            "Assalomu alaykum! Botdan foydalanish uchun ro'yxatdan o'tishingiz kerak.\n\n"
            "Pastdagi tugmani bosib telefon raqamingizni yuboring ğŸ‘‡",
            reply_markup=get_register_kb()
        )

@dp.message(F.contact)
async def handle_contact(message: Message):
    # Foydalanuvchini bazaga saqlash
    user_id = message.from_user.id
    full_name = message.from_user.full_name
    phone = message.contact.phone_number
    
    conn = sqlite3.connect('choyxona.db')
    cursor = conn.cursor()
    cursor.execute('INSERT OR REPLACE INTO users (user_id, full_name, phone) VALUES (?, ?, ?)', 
                   (user_id, full_name, phone))
    conn.commit()
    conn.close()
    
    await message.answer(
        "Muvaffaqiyatli ro'yxatdan o'tdingiz! âœ…",
        reply_markup=get_main_menu()
    )
    
    # Adminga yangi mijoz haqida xabar
    await bot.send_message(
        ADMIN_ID, 
        f"ğŸ†• **Yangi mijoz!**\nğŸ‘¤ Ism: {full_name}\nğŸ“ Tel: {phone}\nğŸ†” ID: `{user_id}`",
        parse_mode="Markdown"
    )

@dp.message(F.web_app_data)
async def handle_webapp_data(message: Message):
    try:
        data = json.loads(message.web_app_data.data)
        user = get_user(message.from_user.id)
        
        items = data.get('items', 'Noma\'lum')
        total = data.get('total_price', 0)
        date_now = datetime.now().strftime("%d.%m.%Y %H:%M")

        # Bazaga buyurtmani saqlash
        conn = sqlite3.connect('choyxona.db')
        cursor = conn.cursor()
        cursor.execute('INSERT INTO orders (user_id, items, total_price, date) VALUES (?, ?, ?, ?)', 
                       (message.from_user.id, str(items), total, date_now))
        conn.commit()
        conn.close()

        # Adminga buyurtma (mijoz telefoni bilan)
        admin_text = (
            f"ğŸ› **YANGI BUYURTMA!**\n\n"
            f"ğŸ‘¤ Mijoz: {user[1]}\n"
            f"ğŸ“ Tel: {user[2]}\n"
            f"ğŸ± Taomlar: {items}\n"
            f"ğŸ’° Jami: {total} so'm"
        )
        await bot.send_message(ADMIN_ID, admin_text, parse_mode="Markdown")
        await message.answer("Buyurtmangiz qabul qilindi! âœ…")

    except Exception as e:
        print(f"Xato: {e}")

async def main():
    print("ğŸš€ Bot ishga tushdi...")
    await dp.start_polling(bot)

if __name__ == '__main__':
    asyncio.run(main())
